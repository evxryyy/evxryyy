name: Update GitHub Card

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

env:
  GH_USER: evxryyy
  OUT_PATH: assets/github-card.svg
  TMP: /tmp/github-card.tmp

jobs:
  update-card:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare
        run: |
          mkdir -p "$(dirname "$OUT_PATH")"
          rm -f "$TMP" "$OUT_PATH"

      - name: Try direct .svg then extract generated .svg from /card page
        run: |
          SVG_URL="https://githubcard.com/${GH_USER}.svg"
          CARD_URL="https://githubcard.com/${GH_USER}/card"

          # 1) Try direct svg endpoint
          curl -sL "$SVG_URL" -o "$TMP" || true
          if grep -q "<svg" "$TMP"; then
            mv "$TMP" "$OUT_PATH"
            echo "Direct .svg OK"
            exit 0
          fi

          # 2) Fetch /card HTML and try to find an absolute .svg URL generated by the site
          curl -sL "$CARD_URL" -o "$TMP" || true

          # Try to extract full https?://... .svg URL first
          SVG_LINK=$(grep -Eo 'https?://[^"'"'\'']+\.svg(\?[^"'"'\'']*)?' "$TMP" | head -n1 || true)

          # If not found, try common HTML attributes (href/src/data-src)
          if [ -z "$SVG_LINK" ]; then
            SVG_LINK=$(sed -n 's/.*href="\([^"]*\.svg[^"]*\)".*/\1/p' "$TMP" | head -n1 || true)
          fi
          if [ -z "$SVG_LINK" ]; then
            SVG_LINK=$(sed -n "s/.*src='\([^']*\.svg[^']*\)'.*/\1/p" "$TMP" | head -n1 || true)
          fi
          if [ -z "$SVG_LINK" ]; then
            SVG_LINK=$(sed -n 's/.*data-src="\([^"]*\.svg[^"]*\)".*/\1/p' "$TMP" | head -n1 || true)
          fi

          # Normalize protocol-relative URLs (//...)
          if [ -n "$SVG_LINK" ] && echo "$SVG_LINK" | grep -q "^//"; then
            SVG_LINK="https:${SVG_LINK}"
          fi

          # If we got a relative path like /path/to/file.svg, prefix site origin
          if [ -n "$SVG_LINK" ] && echo "$SVG_LINK" | grep -q "^/"; then
            SVG_LINK="https://githubcard.com${SVG_LINK}"
          fi

          # 3) If we found an SVG link, download it
          if [ -n "$SVG_LINK" ]; then
            echo "Found SVG link: $SVG_LINK"
            curl -sL "$SVG_LINK" -o "$OUT_PATH" || true
            if [ -s "$OUT_PATH" ] && grep -q "<svg" "$OUT_PATH"; then
              echo "Downloaded generated SVG"
              exit 0
            else
              echo "Downloaded file is not a valid SVG, falling back"
              rm -f "$OUT_PATH"
            fi
          else
            echo "No SVG link found in /card HTML"
          fi

          # 4) As last resort try to extract inline <svg> from the /card HTML
          if grep -q "<svg" "$TMP"; then
            awk 'BEGIN{found=0} /<svg/{found=1} found{print} /<\/svg>/{print; exit}' "$TMP" > "$OUT_PATH" || true
            if [ -s "$OUT_PATH" ] && grep -q "<svg" "$OUT_PATH"; then
              echo "Extracted inline SVG from /card HTML"
              exit 0
            fi
          fi

          # 5) Final fallback: write a minimal error SVG to avoid broken README
          printf '<svg xmlns="http://www.w3.org/2000/svg" width="600" height="120"><rect width="100%%" height="100%%" fill="#111"/><text x="50%%" y="50%%" dominant-baseline="middle" text-anchor="middle" fill="#fff" font-family="sans-serif" font-size="14">GitHub Card unavailable</text></svg>' > "$OUT_PATH"
          echo "Fallback SVG written"

      - name: Validate SVG
        run: |
          if [ ! -s "$OUT_PATH" ] || ! grep -q "<svg" "$OUT_PATH"; then
            echo "SVG is missing or invalid"
            exit 1
          fi

      - name: Commit & Push if changed
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          git add "$OUT_PATH"
          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          git commit -m "Auto-update GitHub Card"
          git push

name: Update GitHub Card v2

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

env:
  GH_USER: evxryyy
  OUT_PATH: assets/github-card.svg
  TMP: /tmp/github-card.tmp

jobs:
  update-card:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch GitHub Card
        run: |
          mkdir -p "$(dirname "$OUT_PATH")"
          rm -f "$TMP" "$OUT_PATH"

          SVG_URL="https://githubcard.com/${GH_USER}.svg"
          CARD_URL="https://githubcard.com/${GH_USER}/card"

          curl -sL "$SVG_URL" -o "$TMP" || true

          if grep -q "<svg" "$TMP"; then
            awk 'BEGIN{found=0} /<svg/{found=1} found{print} /<\/svg>/{print; exit}' "$TMP" > "$OUT_PATH"
          else
            curl -sL "$CARD_URL" -o "$TMP" || true

            if grep -q "<svg" "$TMP"; then
              awk 'BEGIN{found=0} /<svg/{found=1} found{print} /<\/svg>/{print; exit}' "$TMP" > "$OUT_PATH"
            else
              printf '<svg xmlns="http://www.w3.org/2000/svg" width="600" height="120"><rect width="100%%" height="100%%" fill="#111"/><text x="50%%" y="50%%" dominant-baseline="middle" text-anchor="middle" fill="#fff" font-family="sans-serif" font-size="14">GitHub Card unavailable</text></svg>' > "$OUT_PATH"
            fi
          fi

          if [ ! -s "$OUT_PATH" ] || ! grep -q "<svg" "$OUT_PATH"; then
            echo "Invalid SVG generated"
            exit 1
          fi

      - name: Commit & Push
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          git add "$OUT_PATH"
          git commit -m "Auto-update GitHub Card" || exit 0
          git push

name: Update Contributions SVG Badge
on:
  schedule:
    - cron: "0 5 * * *"   # quotidien Ã  05:00 UTC
  workflow_dispatch:

jobs:
  update-badge:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Set GH_USER
        run: echo "GH_USER=${GITHUB_REPOSITORY_OWNER:-${{ github.repository_owner }}}" >> $GITHUB_ENV

      - name: Query GraphQL for contributions (fixed)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          GH_USER="${GITHUB_REPOSITORY_OWNER:-${{ github.repository_owner }}}"
          echo "Using GH_USER=$GH_USER"

          # build payload safely with jq
          query='query ($login: String!) { user(login: $login) { contributionsCollection { contributionCalendar { totalContributions } } } }'
          PAYLOAD=$(jq -n --arg q "$query" --arg login "$GH_USER" '{"query":$q,"variables":{"login":$login}}')

          echo "Payload:"
          echo "$PAYLOAD"

          resp=$(curl -s -X POST -H "Authorization: bearer $GITHUB_TOKEN" -H "Content-Type: application/json" -d "$PAYLOAD" https://api.github.com/graphql)
          echo "Raw response:"
          echo "$resp"

          err=$(echo "$resp" | jq -r '.errors[0].message // empty')
          if [ -n "$err" ]; then
            echo "GraphQL error: $err"
            exit 1
          fi

          total=$(echo "$resp" | jq -r '.data.user.contributionsCollection.contributionCalendar.totalContributions // "0"')
          echo "TOTAL_CONTRIBS=$total" >> $GITHUB_ENV
          echo "Found total: $total"


      - name: Commit SVG to repo
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "chore: update contributions SVG badge"
          file_pattern: contribs-badge.svg
          branch: main
          author_name: github-actions
          author_email: actions@github.com
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
